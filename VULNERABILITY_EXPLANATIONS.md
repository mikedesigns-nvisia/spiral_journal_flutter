# Common Vulnerabilities and How They Apply to Spiral Journal

## 1. API Key Exposure

### What is it?
API key exposure occurs when sensitive authentication credentials are stored in plaintext in source code, configuration files, or logs where unauthorized users can access them.

### How it affects Spiral Journal
The app currently has an Anthropic API key stored in the `.env` file which appears to be committed to the repository. This means anyone with access to the repository can use this key to make API calls at the app's expense.

### Real Impact
- **Financial Loss**: Attackers can use the API key to make expensive API calls
- **Rate Limit Exhaustion**: Malicious use can hit rate limits, breaking the app for legitimate users
- **Data Exposure**: Attackers might be able to access API logs or analytics

### Example Attack
```bash
# Attacker finds the key in the repository
git clone https://github.com/user/spiral_journal
cat .env
# CLAUDE_API_KEY=sk-ant-api03-yfRR...

# Attacker uses the key
curl https://api.anthropic.com/v1/messages \
  -H "x-api-key: sk-ant-api03-yfRR..." \
  -d '{"messages": [{"role": "user", "content": "..."}]}'
```

## 2. Weak Password Storage

### What is it?
Using inadequate hashing algorithms (like unsalted SHA-256) to store passwords makes it easy for attackers who gain access to the password database to recover the original passwords.

### How it affects Spiral Journal
The app uses SHA-256 without salt for password hashing in `LocalAuthService`. This is vulnerable to:
- **Rainbow Table Attacks**: Pre-computed hashes for common passwords
- **Brute Force**: SHA-256 is fast, allowing billions of attempts per second
- **Same Password Detection**: Users with the same password have the same hash

### Real Impact
If an attacker gains access to the device's secure storage:
```dart
// Current vulnerable implementation
String _hashPassword(String password) {
  final bytes = utf8.encode(password);
  final digest = sha256.convert(bytes);
  return digest.toString();
}
// "password123" always becomes "482c811da5d5b4bc6d497ffa98491e38"
```

### Example Attack
```python
# Attacker with stolen hash
import hashlib

stolen_hash = "482c811da5d5b4bc6d497ffa98491e38"
common_passwords = ["password", "123456", "password123", ...]

for password in common_passwords:
    if hashlib.sha256(password.encode()).hexdigest() == stolen_hash:
        print(f"Password found: {password}")
        break
```

## 3. SQL Injection

### What is it?
SQL injection occurs when user input is directly concatenated into SQL queries, allowing attackers to modify the query structure and access or modify data they shouldn't.

### How it affects Spiral Journal
While the app generally uses parameterized queries, any use of string concatenation in SQL queries could be vulnerable.

### Real Impact
```dart
// Vulnerable code example
String searchTerm = "'; DROP TABLE journal_entries; --";
db.rawQuery("SELECT * FROM entries WHERE content LIKE '%" + searchTerm + "%'");
// Results in: SELECT * FROM entries WHERE content LIKE '%'; DROP TABLE journal_entries; --%'
```

### Prevention in Current Code
The app correctly uses parameterized queries in most places:
```dart
db.query(
  'journal_entries',
  where: 'content LIKE ?',
  whereArgs: ['%$searchTerm%'],
);
```

## 4. Insufficient Input Validation

### What is it?
Accepting user input without proper validation can lead to various attacks including XSS, buffer overflows, and application crashes.

### How it affects Spiral Journal
Journal entries are stored without content sanitization, which could lead to:
- **XSS**: If entries are displayed in a WebView
- **DoS**: Very large entries could crash the app
- **Injection Attacks**: Special characters could break formatting

### Real Impact
```dart
// Potential XSS if displayed in WebView
String journalEntry = "<img src=x onerror=alert('XSS')>";

// Potential DoS
String hugeEntry = "A" * 10000000; // 10MB of text

// Potential formatting issues
String entry = "Entry with \u0000 null bytes and \u202E RTL override";
```

## 5. Insecure Data Storage

### What is it?
Storing sensitive data without encryption allows attackers with physical or root access to read user data directly.

### How it affects Spiral Journal
While the app uses SQLCipher for database encryption, some areas of concern:
- Export functionality allows unencrypted exports
- Temporary files might not be encrypted
- Logs might contain sensitive data

### Real Impact
```dart
// Vulnerable export
final json = jsonEncode(allJournalEntries);
await File('export.json').writeAsString(json); // Unencrypted!

// Now readable by any app with file access
cat /data/data/com.spiraljournal/files/export.json
```

## 6. Missing Certificate Pinning

### What is it?
Without certificate pinning, the app trusts any certificate signed by a trusted CA, making it vulnerable to man-in-the-middle attacks with fraudulent certificates.

### How it affects Spiral Journal
The app relies on OS-level certificate validation. An attacker with a fraudulent certificate could:
- Intercept API calls to Anthropic
- Steal API keys in transit
- Modify AI responses

### Real Impact
```
User Device <---> [Attacker's Proxy] <---> api.anthropic.com
                  ^
                  |
                  Fraudulent certificate
                  (but signed by trusted CA)
```

## 7. Sensitive Data in Logs

### What is it?
Logging sensitive information makes it accessible to other apps (on Android) or anyone with device access, potentially exposing user data.

### How it affects Spiral Journal
The app logs:
- API key prefixes (first 20 characters)
- Authentication states
- User behavior patterns

### Real Impact
```dart
// Current vulnerable logging
debugPrint('API Key: ${apiKey.substring(0, 20)}...');
// Logs: "API Key: sk-ant-api03-yfRR-1-..."

// On Android, readable by other apps with READ_LOGS permission
adb logcat | grep "API Key"
```

## 8. Predictable Resource IDs

### What is it?
Using predictable patterns for generating IDs allows attackers to guess valid IDs and potentially access resources they shouldn't.

### How it affects Spiral Journal
User IDs are generated using timestamp-based patterns:
```dart
final timestamp = DateTime.now().millisecondsSinceEpoch.toString();
final randomBytes = List.generate(16, (i) => timestamp.hashCode + i);
```

### Real Impact
An attacker could predict user IDs by:
1. Knowing approximate account creation time
2. Generating IDs for timestamps around that time
3. Testing these IDs for validity

## 9. Lack of Rate Limiting

### What is it?
Without rate limiting, attackers can make unlimited requests, leading to:
- Brute force attacks
- Denial of service
- Resource exhaustion

### How it affects Spiral Journal
The app has no apparent rate limiting for:
- Journal entry creation
- Authentication attempts
- API calls

### Real Impact
```dart
// Attacker's script
for (int i = 0; i < 1000000; i++) {
  await createJournalEntry("Spam entry $i");
}
// Results in: Database full, app crashes
```

## 10. Missing Jailbreak/Root Detection

### What is it?
Jailbroken/rooted devices have compromised security models, allowing attackers to bypass app sandboxing and access sensitive data.

### How it affects Spiral Journal
On a jailbroken device:
- Keychain/Keystore can be dumped
- SSL pinning can be bypassed
- App memory can be read
- Database encryption keys can be extracted

### Real Impact
```bash
# On jailbroken iOS device
./keychain_dumper | grep spiral_journal
# Outputs all stored passwords and API keys

# On rooted Android
su
cat /data/data/com.spiraljournal/databases/*
# Even "encrypted" databases can be accessed
```

## Mitigation Summary

Each vulnerability has proven mitigation strategies:

1. **API Keys**: Use server-side proxy or build-time injection
2. **Passwords**: Use bcrypt/Argon2 with salt
3. **SQL Injection**: Always use parameterized queries
4. **Input Validation**: Sanitize and validate all inputs
5. **Data Storage**: Encrypt all sensitive data
6. **Certificate Pinning**: Implement in-app certificate validation
7. **Logging**: Use structured logging with filters
8. **Resource IDs**: Use cryptographically secure random generation
9. **Rate Limiting**: Implement request throttling
10. **Device Security**: Add jailbreak/root detection

Remember: Security is about layers. No single measure is perfect, but multiple layers create a robust defense.